<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>API Data Table</title>
    <!-- Include Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <!-- Include DataTables CSS -->
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.min.css"
    />
  </head>
  <body>
    <div class="container">
      <h1 class="mt-5">API Data Table</h1>
      <table id="data-table" class="table">
        <thead class="thead-dark">
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Language</th>
            <th>Age</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <!-- Data will be displayed here -->
        </tbody>
      </table>
    </div>

    <!-- Add a modal for editing -->
    <div
      class="modal fade"
      id="editModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="editModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editModalLabel">Edit Row</h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <!-- Form for editing row data -->
            <form id="editForm">
              <div class="form-group">
                <label for="editID">ID</label>
                <input type="text" class="form-control" id="editID" readonly />
              </div>
              <div class="form-group">
                <label for="editName">Name</label>
                <input
                  type="text"
                  class="form-control"
                  id="editName"
                  required
                  pattern="[A-Za-z]+"
                  title="Please enter only letters"
                />
              </div>
              <div class="form-group">
                <label for="editLanguage">Language</label>
                <input
                  type="text"
                  class="form-control"
                  id="editLanguage"
                  required
                  pattern="[A-Za-z]+"
                  title="Please enter only letters"
                />
              </div>
              <div class="form-group">
                <label for="editAge">Age</label>
                <input type="number" class="form-control" id="editAge" />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Close
            </button>
            <button type="button" class="btn btn-primary" id="saveChanges">
              Save Changes
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Include jQuery, Bootstrap JS, and DataTables JavaScript -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script
      type="text/javascript"
      charset="utf8"
      src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"
    ></script>

    <script>
      // Function to fetch data from the API
      function fetchData() {
        fetch("http://127.0.0.1:5000/get_data")
          .then((response) => response.json())
          .then((data) => {
            const dataTable = $("#data-table").DataTable({
              columnDefs: [
                {
                  targets: -1, // Target the last column (Action column)
                  data: null,
                  defaultContent:
                    "<button class='btn btn-primary edit-button'>Edit</button> <button class='btn btn-danger delete-button'>Delete</button>", // Edit and Delete buttons
                },
              ],
            });

            const dataList = data.message;

            // Loop through the dataList and add rows to the DataTable
            dataList.forEach((user) => {
              dataTable.row
                .add([
                  user.ID,
                  user.Name,
                  user.Language,
                  user.Age,
                  null, // Placeholder for the Edit and Delete buttons
                ])
                .draw();
            });

            // Add an event handler for the Edit button
            $("#data-table tbody").on("click", ".edit-button", function () {
              const data = dataTable.row($(this).parents("tr")).data();
              // Populate the modal fields with the existing data
              $("#editID").val(data[0]);
              $("#editName").val(data[1]);
              $("#editLanguage").val(data[2]);
              $("#editAge").val(data[3]);
              // Show the modal for editing
              $("#editModal").modal("show");
            });

            // Handle the "Save Changes" button click
            $("#saveChanges").on("click", function () {
              // Retrieve the edited data from the modal fields
              const editedID = $("#editID").val();
              const editedName = $("#editName").val();
              const editedLanguage = $("#editLanguage").val();
              const editedAge = $("#editAge").val();

              // Create an object with the edited data
              const editedData = {
                ID: editedID,
                Name: editedName,
                Language: editedLanguage,
                Age: editedAge,
              };

              if (!validateForm(editedName, editedLanguage, editedAge)) {
                // Validation failed, show an error message or prevent the form submission.
                alert("Please enter valid data.");
                return;
              }

              function validateForm(name, language, age) {
                // Check if name and language are non-empty strings
                if (name.trim() === "" || language.trim() === "") {
                  return false;
                }

                // Check if age is a positive integer
                if (!/^\d+$/.test(age) || parseInt(age) < 0) {
                  return false;
                }

                return true;
              }

              // Send a PUT request to update the data on the server
              fetch("http://127.0.0.1:5000/", {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(editedData),
              })
                .then((response) => response.json())
                .then((data) => {
                  if (data.status_code == 200) {
                    // Update the DataTable with the edited data
                    // const row = dataTable.row($(this).parents("tr"));
                    // row
                    //   .data([editedID, editedName, editedLanguage, editedAge])
                    //   .draw();
                    location.reload();
                    // Close the modal
                    $("#editModal").modal("hide");
                  } else {
                    alert("Error updating data on the server.");
                  }
                })
                .catch((error) => {
                  alert("Error updating data on the server.");
                });
            });

            // Add an event handler for the Delete button
            $("#data-table tbody").on("click", ".delete-button", function () {
              const data = dataTable.row($(this).parents("tr")).data();
              const recordID = data[0]; // Assuming ID is in the first column

              if (confirm("Are you sure you want to delete this record?")) {
                // Send a DELETE request to delete the data on the server
                fetch(`http://127.0.0.1:5000/${recordID}`, {
                  method: "DELETE",
                  headers: {
                    "Content-Type": "application/json",
                  },
                })
                  .then((response) => response.json())
                  .then((data) => {
                    if (data.status_code == 200) {
                      // Reload the page to update the DataTable
                      location.reload();
                    } else {
                      alert("Error deleting data on the server.");
                    }
                  })
                  .catch((error) => {
                    console.error("Error deleting data on the server:", error); // Add error handling
                    alert("Error deleting data on the server.");
                  });
              }
            });
          })
          .catch((error) => console.error("Error fetching data:", error));
      }

      // Call the fetchData function to populate the table
      fetchData();
    </script>
  </body>
</html>
